@page "/produtos"

@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entities
@inject ApplicationDbContext db
@inject NavigationManager nav

<h3>Produtos</h3>

@if (!string.IsNullOrEmpty(mensagemErro))
{
    <div class="alert alert-danger">@mensagemErro</div>
}


<AuthorizeView Roles="Administrador">
    <button class="btn btn-link p-0 mb-2" title="Novo Produto" @onclick="Criar">
        <img src="img/novo.png" alt="Novo" style="width:32px;height:32px;" />
    </button>
</AuthorizeView>

<div class="mb-3">
    <label>Filtrar por Estado:</label>
    <select class="form-select" style="width:200px;" @onchange="FiltrarEstado">
        <option value="">Todos</option>
        <option value="Pendente">Pendente</option>
        <option value="Ativo">Ativo</option>
        <option value="Inativo">Inativo</option>
    </select>
</div>

@if (produtos is null)
{
    <p>A carregar...</p>
}
else if (!produtos.Any())
{
    <div class="alert alert-warning">Nenhum produto encontrado.</div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Id</th>
                <th>Imagem</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Fornecedor</th>
                <th>Preço Base</th>
                <th>Percentagem</th>
                <th>Preço Final</th>
                <th>Stock</th>
                <th>Estado</th>
                <th>Modo de Entrega</th>
                <th style="width: 220px;">Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in produtosPaginados)
            {
                <tr>
                    <td>@p.Id</td>
                    <td><img src="img/@p.Imagem" width="60" class="img-thumbnail" /></td>
                    <td>@p.Nome</td>
                    <td>@p.Categoria?.Nome</td>
                    <td>@p.Fornecedor?.NomeEmpresa</td>
                    <td>@p.PrecoBase €</td>
                    <td>@p.Percentagem %</td>
                    <td>@p.PrecoFinal €</td>
                    <td>@p.Stock</td>

                    <td>
                        @if (p.Estado == "Ativo")
                        {
                            <span class="badge bg-success">Ativo</span>
                        }
                        else if (p.Estado == "Pendente")
                        {
                            <span class="badge bg-warning">Pendente</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inativo</span>
                        }
                    </td>

                    <td>@p.ModoEntrega?.Tipo</td>

                    <td>
                        <AuthorizeView Roles="Administrador">

                            @if (p.Estado == "Pendente")
                            {
                                <button class="btn btn-success btn-sm me-1"
                                        @onclick="() => Aprovar(p)">
                                    Aprovar
                                </button>
                            }

                            @if (p.Estado == "Ativo")
                            {
                                <button class="btn btn-secondary btn-sm me-1"
                                        @onclick="() => Inativar(p)">
                                    Inativar
                                </button>
                            }

                            @if (p.Estado == "Inativo")
                            {
                                <button class="btn btn-success btn-sm me-1"
                                        @onclick="() => Ativar(p)">
                                    Ativar
                                </button>
                            }

                            <button class="btn btn-warning btn-sm"
                                    @onclick="() => Editar(p.Id)">
                                Editar
                            </button>

                            <button class="btn btn-danger btn-sm ms-1"
                                    @onclick="() => Apagar(p)">
                                Apagar
                            </button>



                        </AuthorizeView>
                    </td>

                </tr>
            }
        </tbody>
    </table>

    <div class="mt-3 d-flex justify-content-center">

    <button class="btn btn-outline-primary me-2"
            @onclick="PaginaAnterior"
            disabled="@(!PodePaginaAnterior)">
        « Anterior
    </button>

    @for (int i = 1; i <= totalPaginas; i++)
    {
        <button class="btn @(i == paginaAtual ? "btn-primary" : "btn-outline-primary") me-1"
                @onclick="(() => IrParaPagina(i))">
            @i
        </button>
    }

    <button class="btn btn-outline-primary ms-2"
            @onclick="ProximaPagina"
            disabled="@(!PodeProximaPagina)">
        Próxima »
    </button>

</div>

}

@code {

    List<Produtos>? produtos;
    string filtroEstado = "";

    string? mensagemErro = null;

    int paginaAtual = 1;
    int tamanhoPagina = 10; // 10 produtos por página
    int totalPaginas = 1;

    bool PodePaginaAnterior => paginaAtual > 1;
    bool PodeProximaPagina => paginaAtual < totalPaginas;

    void PaginaAnterior()
    {
        if (paginaAtual > 1)
            paginaAtual--;

        CarregarProdutos();
    }

    void ProximaPagina()
    {
        if (paginaAtual < totalPaginas)
            paginaAtual++;

        CarregarProdutos();
    }

    void IrParaPagina(int pagina)
    {
        paginaAtual = pagina;
        CarregarProdutos();
    }


    List<Produtos> produtosPaginados = new();



    protected override void OnInitialized()
    {
        CarregarProdutos();
    }

    void CarregarProdutos()
    {
        var query = db.Produtos
            .Include(p => p.Categoria)
            .Include(p => p.Fornecedor)
            .Include(p => p.ModoEntrega)
            .OrderBy(p => p.Nome)
            .AsQueryable();

        if (!string.IsNullOrEmpty(filtroEstado))
            query = query.Where(p => p.Estado == filtroEstado);

        var totalProdutos = query.Count();
        totalPaginas = (int)Math.Ceiling(totalProdutos / (double)tamanhoPagina);

        if (paginaAtual > totalPaginas)
            paginaAtual = totalPaginas == 0 ? 1 : totalPaginas;

        produtos = query.ToList();

        produtosPaginados = query
            .Skip((paginaAtual - 1) * tamanhoPagina)
            .Take(tamanhoPagina)
            .ToList();
    }


    void FiltrarEstado(ChangeEventArgs e)
    {
        filtroEstado = e.Value?.ToString() ?? "";
        CarregarProdutos();
    }

    void Criar()
    {
        nav.NavigateTo("/produtos/criar");
    }

    void Editar(int id)
    {
        nav.NavigateTo($"/produtos/editar/{id}");
    }

    async void Apagar(Produtos p)
    {
        // Verificar se o produto tem vendas associadas
        bool temVendas = db.LinhasVenda.Any(l => l.ProdutoId == p.Id);

        if (temVendas)
        {
            // Não pode apagar — mostrar mensagem
            mensagemErro = "Não é possível apagar este produto porque existem vendas associadas.";
            return;
        }

        // Caso não tenha vendas — apagar fisicamente
        db.Produtos.Remove(p);
        db.SaveChanges();

        CarregarProdutos();
    }


    void AlterarEstado(Produtos p, string novoEstado)
    {
        p.Estado = novoEstado;

        // recalcular preco final
        p.PrecoFinal = p.PrecoBase + (p.PrecoBase * (p.Percentagem / 100));

        db.SaveChanges();
        CarregarProdutos();
    }

    void Aprovar(Produtos p)
    {
        AlterarEstado(p, "Ativo");
    }

    void Ativar(Produtos p)
    {
        AlterarEstado(p, "Ativo");
    }

    void Inativar(Produtos p)
    {
        AlterarEstado(p, "Inativo");
    }
}
