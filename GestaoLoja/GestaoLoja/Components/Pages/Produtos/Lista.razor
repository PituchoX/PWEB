@page "/produtos"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrador,Funcionário")]
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entities
@inject ApplicationDbContext db
@inject NavigationManager nav

<h3>Produtos</h3>

@if (!string.IsNullOrEmpty(mensagemErro))
{
    <div class="alert alert-danger">@mensagemErro</div>
}

<AuthorizeView Roles="Administrador,Funcionário">
    <button class="btn btn-primary btn-sm mb-3" @onclick="Criar">
        Novo Produto
    </button>
</AuthorizeView>

<!-- FILTROS -->
<div class="card mb-3">
    <div class="card-header bg-light">
        Filtros
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Estado:</label>
                <select class="form-select" @onchange="FiltrarEstado">
                    <option value="">Todos os estados</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Ativo">Ativo</option>
                    <option value="Inativo">Inativo</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Categoria:</label>
                <select class="form-select" @onchange="FiltrarCategoria">
                    <option value="">Todas as categorias</option>
                    @if (categoriasDisponiveis != null)
                    {
                        @foreach (var cat in categoriasDisponiveis)
                        {
                            <option value="@cat.Id">@cat.Nome</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Subcategoria:</label>
                <select class="form-select" @onchange="FiltrarSubcategoria" disabled="@(!filtroCategoria.HasValue)">
                    <option value="">Todas</option>
                    @foreach (var sub in subcategoriasFiltradas)
                    {
                        <option value="@sub.Id">@sub.Nome</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Ordenar por:</label>
                <select class="form-select" @onchange="OrdenarPor">
                    <option value="nome">Nome (A-Z)</option>
                    <option value="nome_desc">Nome (Z-A)</option>
                    <option value="preco">Preço (menor)</option>
                    <option value="preco_desc">Preço (maior)</option>
                    <option value="stock">Stock (menor)</option>
                    <option value="stock_desc">Stock (maior)</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" @onclick="LimparFiltros">
                    Limpar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

@if (produtos is null)
{
    <p>A carregar...</p>
}
else if (!produtos.Any())
{
    <div class="alert alert-warning">Nenhum produto encontrado.</div>
}
else
{
    <div class="mb-2 text-muted">
        <small>A mostrar @produtosPaginados.Count de @produtos.Count produtos</small>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Imagem</th>
                    <th>Nome</th>
                    <th>Categoria</th>
                    <th>Subcategoria</th>
                    <th>Fornecedor</th>
                    <th>Preço Base</th>
                    <th>%</th>
                    <th>Preço Final</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th style="width: 200px;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in produtosPaginados)
                {
                    <tr>
                        <td>@p.Id</td>
                        <td><img src="img/@p.Imagem" width="50" class="img-thumbnail" /></td>
                        <td>@p.Nome</td>
                        <td>@p.Categoria?.Nome</td>
                        <td>
                            @if (p.Subcategoria != null)
                            {
                                <span>@p.Subcategoria.Nome</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>@p.Fornecedor?.NomeEmpresa</td>
                        <td>@p.PrecoBase.ToString("0.00") €</td>
                        <td>@p.Percentagem.ToString("0.00")%</td>
                        <td><strong>@p.PrecoFinal.ToString("0.00") €</strong></td>
                        <td>
                            @if (p.Stock <= 5)
                            {
                                <span class="badge bg-danger">@p.Stock</span>
                            }
                            else
                            {
                                <span>@p.Stock</span>
                            }
                        </td>
                        <td>
                            @if (p.Estado == "Ativo")
                            {
                                <span class="badge bg-success">Ativo</span>
                            }
                            else if (p.Estado == "Pendente")
                            {
                                <span class="badge bg-warning">Pendente</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inativo</span>
                            }
                        </td>
                        <td>
                            <AuthorizeView Roles="Administrador,Funcionário">
                                @if (p.Estado == "Pendente")
                                {
                                    <button class="btn btn-success btn-sm me-1" @onclick="() => Aprovar(p)">
                                        Aprovar
                                    </button>
                                }
                                @if (p.Estado == "Ativo")
                                {
                                    <button class="btn btn-secondary btn-sm me-1" @onclick="() => Inativar(p)">
                                        Inativar
                                    </button>
                                }
                                @if (p.Estado == "Inativo")
                                {
                                    <button class="btn btn-success btn-sm me-1" @onclick="() => Ativar(p)">
                                        Ativar
                                    </button>
                                }
                                <button class="btn btn-warning btn-sm" @onclick="() => Editar(p.Id)">
                                    Editar
                                </button>
                                <button class="btn btn-danger btn-sm ms-1" @onclick="() => Apagar(p)">
                                    Apagar
                                </button>
                            </AuthorizeView>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- PAGINAÇÃO -->
    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item @(!PodePaginaAnterior ? "disabled" : "")">
                <button class="page-link" @onclick="PaginaAnterior" disabled="@(!PodePaginaAnterior)">
                    Anterior
                </button>
            </li>
            @for (int i = 1; i <= totalPaginas; i++)
            {
                var pagina = i;
                <li class="page-item @(pagina == paginaAtual ? "active" : "")">
                    <button class="page-link" @onclick="@(() => IrParaPagina(pagina))">
                        @pagina
                    </button>
                </li>
            }
            <li class="page-item @(!PodeProximaPagina ? "disabled" : "")">
                <button class="page-link" @onclick="ProximaPagina" disabled="@(!PodeProximaPagina)">
                    Próxima
                </button>
            </li>
        </ul>
    </nav>
}

@code {
    List<Produtos>? produtos;
    List<Categorias>? categoriasDisponiveis;
    List<Subcategoria> todasSubcategorias = new();
    List<Subcategoria> subcategoriasFiltradas = new();
    string filtroEstado = "";
    int? filtroCategoria = null;
    int? filtroSubcategoria = null;
    string ordenacao = "nome";
    string? mensagemErro = null;

    int paginaAtual = 1;
    int tamanhoPagina = 10;
    int totalPaginas = 1;

    bool PodePaginaAnterior => paginaAtual > 1;
    bool PodeProximaPagina => paginaAtual < totalPaginas;

    List<Produtos> produtosPaginados = new();

    protected override void OnInitialized()
    {
        categoriasDisponiveis = db.Categorias.OrderBy(c => c.Nome).ToList();
        todasSubcategorias = db.Subcategorias.OrderBy(s => s.Nome).ToList();
        CarregarProdutos();
    }

    void CarregarProdutos()
    {
        var query = db.Produtos
            .Include(p => p.Categoria)
            .Include(p => p.Subcategoria)
            .Include(p => p.Fornecedor)
            .Include(p => p.ModoEntrega)
            .AsQueryable();

        if (!string.IsNullOrEmpty(filtroEstado))
            query = query.Where(p => p.Estado == filtroEstado);

        if (filtroCategoria.HasValue)
            query = query.Where(p => p.CategoriaId == filtroCategoria.Value);

        if (filtroSubcategoria.HasValue)
            query = query.Where(p => p.SubcategoriaId == filtroSubcategoria.Value);

        query = ordenacao switch
        {
            "nome" => query.OrderBy(p => p.Nome),
            "nome_desc" => query.OrderByDescending(p => p.Nome),
            "preco" => query.OrderBy(p => p.PrecoFinal),
            "preco_desc" => query.OrderByDescending(p => p.PrecoFinal),
            "stock" => query.OrderBy(p => p.Stock),
            "stock_desc" => query.OrderByDescending(p => p.Stock),
            _ => query.OrderBy(p => p.Nome)
        };

        var totalProdutos = query.Count();
        totalPaginas = (int)Math.Ceiling(totalProdutos / (double)tamanhoPagina);

        if (paginaAtual > totalPaginas)
            paginaAtual = totalPaginas == 0 ? 1 : totalPaginas;

        produtos = query.ToList();

        produtosPaginados = query
            .Skip((paginaAtual - 1) * tamanhoPagina)
            .Take(tamanhoPagina)
            .ToList();
    }

    void PaginaAnterior()
    {
        if (paginaAtual > 1) paginaAtual--;
        CarregarProdutos();
    }

    void ProximaPagina()
    {
        if (paginaAtual < totalPaginas) paginaAtual++;
        CarregarProdutos();
    }

    void IrParaPagina(int pagina)
    {
        paginaAtual = pagina;
        CarregarProdutos();
    }

    void FiltrarEstado(ChangeEventArgs e)
    {
        filtroEstado = e.Value?.ToString() ?? "";
        paginaAtual = 1;
        CarregarProdutos();
    }

    void FiltrarCategoria(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();
        filtroCategoria = string.IsNullOrEmpty(valor) ? null : int.Parse(valor);
        filtroSubcategoria = null;
        
        // Filtrar subcategorias pela categoria selecionada
        if (filtroCategoria.HasValue)
        {
            subcategoriasFiltradas = todasSubcategorias
                .Where(s => s.CategoriaId == filtroCategoria.Value)
                .ToList();
        }
        else
        {
            subcategoriasFiltradas = new();
        }
        
        paginaAtual = 1;
        CarregarProdutos();
    }

    void FiltrarSubcategoria(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();
        filtroSubcategoria = string.IsNullOrEmpty(valor) ? null : int.Parse(valor);
        paginaAtual = 1;
        CarregarProdutos();
    }

    void OrdenarPor(ChangeEventArgs e)
    {
        ordenacao = e.Value?.ToString() ?? "nome";
        paginaAtual = 1;
        CarregarProdutos();
    }

    void LimparFiltros()
    {
        filtroEstado = "";
        filtroCategoria = null;
        filtroSubcategoria = null;
        subcategoriasFiltradas = new();
        ordenacao = "nome";
        paginaAtual = 1;
        CarregarProdutos();
    }

    void Criar() => nav.NavigateTo("/produtos/criar");
    void Editar(int id) => nav.NavigateTo($"/produtos/editar/{id}");

    void Apagar(Produtos p)
    {
        bool temVendas = db.LinhasVenda.Any(l => l.ProdutoId == p.Id);

        if (temVendas)
        {
            mensagemErro = "Não é possível apagar este produto porque existem vendas associadas.";
            return;
        }

        db.Produtos.Remove(p);
        db.SaveChanges();
        mensagemErro = null;
        CarregarProdutos();
    }

    void AlterarEstado(Produtos p, string novoEstado)
    {
        p.Estado = novoEstado;
        p.PrecoFinal = p.PrecoBase + (p.PrecoBase * (p.Percentagem / 100));
        db.SaveChanges();
        CarregarProdutos();
    }

    void Aprovar(Produtos p) => AlterarEstado(p, "Ativo");
    void Inativar(Produtos p) => AlterarEstado(p, "Inativo");
    void Ativar(Produtos p) => AlterarEstado(p, "Ativo");
}
