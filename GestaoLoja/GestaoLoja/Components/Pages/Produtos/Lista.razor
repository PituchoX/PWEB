@page "/produtos"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrador,Funcionário")]
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entities
@inject ApplicationDbContext db
@inject NavigationManager nav

<h3>Produtos</h3>

@if (!string.IsNullOrEmpty(mensagemErro))
{
    <div class="alert alert-danger">@mensagemErro</div>
}

<AuthorizeView Roles="Administrador,Funcionário">
    <button class="btn btn-primary btn-sm mb-3" @onclick="Criar">
        Novo Produto
    </button>
</AuthorizeView>

<!-- FILTROS -->
<div class="card mb-3">
    <div class="card-header bg-light">
        Filtros
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Estado:</label>
                <select class="form-select" @onchange="FiltrarEstado">
                    <option value="">Todos os estados</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Ativo">Ativo</option>
                    <option value="Inativo">Inativo</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Categoria:</label>
                <select class="form-select" @onchange="FiltrarCategoria">
                    <option value="">Todas as categorias</option>
                    @if (categoriasDisponiveis != null)
                    {
                        @foreach (var cat in categoriasDisponiveis)
                        {
                            <option value="@cat.Id">@cat.Nome</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Ordenar por:</label>
                <select class="form-select" @onchange="OrdenarPor">
                    <option value="nome">Nome (A-Z)</option>
                    <option value="nome_desc">Nome (Z-A)</option>
                    <option value="preco">Preco (menor)</option>
                    <option value="preco_desc">Preco (maior)</option>
                    <option value="stock">Stock (menor)</option>
                    <option value="stock_desc">Stock (maior)</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" @onclick="LimparFiltros">
                    Limpar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

@if (produtos is null)
{
    <p>A carregar...</p>
}
else if (!produtos.Any())
{
    <div class="alert alert-warning">Nenhum produto encontrado.</div>
}
else
{
    <div class="mb-2 text-muted">
        <small>A mostrar @produtosPaginados.Count de @produtos.Count produtos</small>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Id</th>
                <th>Imagem</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Fornecedor</th>
                <th>Preco Base</th>
                <th>Percentagem</th>
                <th>Preco Final</th>
                <th>Stock</th>
                <th>Estado</th>
                <th>Modo de Entrega</th>
                <th style="width: 220px;">Acoes</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in produtosPaginados)
            {
                <tr>
                    <td>@p.Id</td>
                    <td><img src="img/@p.Imagem" width="60" class="img-thumbnail" /></td>
                    <td>@p.Nome</td>
                    <td>@p.Categoria?.Nome</td>
                    <td>@p.Fornecedor?.NomeEmpresa</td>
                    <td>@p.PrecoBase EUR</td>
                    <td>@p.Percentagem %</td>
                    <td>@p.PrecoFinal EUR</td>
                    <td>
                        @if (p.Stock <= 5)
                        {
                            <span class="badge bg-danger">@p.Stock</span>
                        }
                        else if (p.Stock <= 20)
                        {
                            <span class="badge bg-warning text-dark">@p.Stock</span>
                        }
                        else
                        {
                            <span>@p.Stock</span>
                        }
                    </td>

                    <td>
                        @if (p.Estado == "Ativo")
                        {
                            <span class="badge bg-success">Ativo</span>
                        }
                        else if (p.Estado == "Pendente")
                        {
                            <span class="badge bg-warning">Pendente</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inativo</span>
                        }
                    </td>

                    <td>@p.ModoEntrega?.Tipo</td>

                    <td>
                        <AuthorizeView Roles="Administrador,Funcionário">
                            @if (p.Estado == "Pendente")
                            {
                                <button class="btn btn-success btn-sm me-1"
                                        @onclick="() => Aprovar(p)">
                                    Aprovar
                                </button>
                            }

                            @if (p.Estado == "Ativo")
                            {
                                <button class="btn btn-secondary btn-sm me-1"
                                        @onclick="() => Inativar(p)">
                                    Inativar
                                </button>
                            }

                            @if (p.Estado == "Inativo")
                            {
                                <button class="btn btn-success btn-sm me-1"
                                        @onclick="() => Ativar(p)">
                                    Ativar
                                </button>
                            }

                            <button class="btn btn-warning btn-sm"
                                    @onclick="() => Editar(p.Id)">
                                Editar
                            </button>

                            <button class="btn btn-danger btn-sm ms-1"
                                    @onclick="() => Apagar(p)">
                                Apagar
                            </button>
                        </AuthorizeView>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- PAGINACAO -->
    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item @(!PodePaginaAnterior ? "disabled" : "")">
                <button class="page-link" @onclick="PaginaAnterior" disabled="@(!PodePaginaAnterior)">
                    Anterior
                </button>
            </li>

            @for (int i = 1; i <= totalPaginas; i++)
            {
                var pagina = i;
                <li class="page-item @(pagina == paginaAtual ? "active" : "")">
                    <button class="page-link" @onclick="@(() => IrParaPagina(pagina))">
                        @pagina
                    </button>
                </li>
            }

            <li class="page-item @(!PodeProximaPagina ? "disabled" : "")">
                <button class="page-link" @onclick="ProximaPagina" disabled="@(!PodeProximaPagina)">
                    Proxima
                </button>
            </li>
        </ul>
    </nav>
}

@code {
    List<Produtos>? produtos;
    List<Categorias>? categoriasDisponiveis;
    string filtroEstado = "";
    int? filtroCategoria = null;
    string ordenacao = "nome";
    string? mensagemErro = null;

    int paginaAtual = 1;
    int tamanhoPagina = 10;
    int totalPaginas = 1;

    bool PodePaginaAnterior => paginaAtual > 1;
    bool PodeProximaPagina => paginaAtual < totalPaginas;

    List<Produtos> produtosPaginados = new();

    protected override void OnInitialized()
    {
        categoriasDisponiveis = db.Categorias.OrderBy(c => c.Nome).ToList();
        CarregarProdutos();
    }

    void CarregarProdutos()
    {
        var query = db.Produtos
            .Include(p => p.Categoria)
            .Include(p => p.Fornecedor)
            .Include(p => p.ModoEntrega)
            .AsQueryable();

        if (!string.IsNullOrEmpty(filtroEstado))
            query = query.Where(p => p.Estado == filtroEstado);

        if (filtroCategoria.HasValue)
            query = query.Where(p => p.CategoriaId == filtroCategoria.Value);

        query = ordenacao switch
        {
            "nome" => query.OrderBy(p => p.Nome),
            "nome_desc" => query.OrderByDescending(p => p.Nome),
            "preco" => query.OrderBy(p => p.PrecoFinal),
            "preco_desc" => query.OrderByDescending(p => p.PrecoFinal),
            "stock" => query.OrderBy(p => p.Stock),
            "stock_desc" => query.OrderByDescending(p => p.Stock),
            _ => query.OrderBy(p => p.Nome)
        };

        var totalProdutos = query.Count();
        totalPaginas = (int)Math.Ceiling(totalProdutos / (double)tamanhoPagina);

        if (paginaAtual > totalPaginas)
            paginaAtual = totalPaginas == 0 ? 1 : totalPaginas;

        produtos = query.ToList();

        produtosPaginados = query
            .Skip((paginaAtual - 1) * tamanhoPagina)
            .Take(tamanhoPagina)
            .ToList();
    }

    void PaginaAnterior()
    {
        if (paginaAtual > 1)
            paginaAtual--;
        CarregarProdutos();
    }

    void ProximaPagina()
    {
        if (paginaAtual < totalPaginas)
            paginaAtual++;
        CarregarProdutos();
    }

    void IrParaPagina(int pagina)
    {
        paginaAtual = pagina;
        CarregarProdutos();
    }

    void FiltrarEstado(ChangeEventArgs e)
    {
        filtroEstado = e.Value?.ToString() ?? "";
        paginaAtual = 1;
        CarregarProdutos();
    }

    void FiltrarCategoria(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();
        filtroCategoria = string.IsNullOrEmpty(valor) ? null : int.Parse(valor);
        paginaAtual = 1;
        CarregarProdutos();
    }

    void OrdenarPor(ChangeEventArgs e)
    {
        ordenacao = e.Value?.ToString() ?? "nome";
        paginaAtual = 1;
        CarregarProdutos();
    }

    void LimparFiltros()
    {
        filtroEstado = "";
        filtroCategoria = null;
        ordenacao = "nome";
        paginaAtual = 1;
        CarregarProdutos();
    }

    void Criar() => nav.NavigateTo("/produtos/criar");

    void Editar(int id) => nav.NavigateTo($"/produtos/editar/{id}");

    void Apagar(Produtos p)
    {
        bool temVendas = db.LinhasVenda.Any(l => l.ProdutoId == p.Id);

        if (temVendas)
        {
            mensagemErro = "Nao e possivel apagar este produto porque existem vendas associadas.";
            return;
        }

        db.Produtos.Remove(p);
        db.SaveChanges();
        mensagemErro = null;
        CarregarProdutos();
    }

    void AlterarEstado(Produtos p, string novoEstado)
    {
        p.Estado = novoEstado;
        p.PrecoFinal = p.PrecoBase + (p.PrecoBase * (p.Percentagem / 100));
        db.SaveChanges();
        CarregarProdutos();
    }

    void Aprovar(Produtos p) => AlterarEstado(p, "Ativo");
    void Ativar(Produtos p) => AlterarEstado(p, "Ativo");
    void Inativar(Produtos p) => AlterarEstado(p, "Inativo");
}
