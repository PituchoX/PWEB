@page "/produtos/editar/{id:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entities
@attribute [Authorize(Roles = "Administrador,Funcionário")]
@inject ApplicationDbContext db
@inject NavigationManager nav
@inject IWebHostEnvironment env
@rendermode InteractiveServer

<h3>Editar Produto</h3>

@if (!string.IsNullOrEmpty(mensagemErro))
{
    <div class="alert alert-danger">@mensagemErro</div>
}

@if (produto == null)
{
    <p>A carregar...</p>
}
else
{
    <EditForm Model="produto" OnValidSubmit="Guardar">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label>Nome</label>
                    <InputText class="form-control" @bind-Value="produto.Nome" />
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label>Preço Base (€)</label>
                            <InputNumber class="form-control" @bind-Value="produto.PrecoBase" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label>Percentagem (%)</label>
                            <InputNumber class="form-control" @bind-Value="produto.Percentagem" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label>Stock</label>
                            <InputNumber class="form-control" @bind-Value="produto.Stock" />
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label>Categoria</label>
                            <InputSelect class="form-select" @bind-Value="produto.CategoriaId" @oninput="OnCategoriaChanged">
                                @foreach (var c in categorias)
                                {
                                    <option value="@c.Id">@c.Nome</option>
                                }
                            </InputSelect>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label>Subcategoria <small class="text-muted">(opcional)</small></label>
                            <select class="form-select" @bind="subcategoriaIdSelecionada">
                                <option value="">-- Nenhuma --</option>
                                @foreach (var s in subcategoriasFiltradas)
                                {
                                    <option value="@s.Id">@s.Nome</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label>Modo de Entrega</label>
                    <InputSelect class="form-select" @bind-Value="produto.ModoEntregaId">
                        @foreach (var m in modos)
                        {
                            <option value="@m.Id">@m.Nome - @m.Tipo</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label>Fornecedor</label>
                    <InputSelect class="form-select" @bind-Value="produto.FornecedorId">
                        @foreach (var f in fornecedores)
                        {
                            <option value="@f.Id">@f.NomeEmpresa</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label>Estado</label>
                    <input class="form-control" value="@produto.Estado" disabled />
                    <small class="text-muted">O estado é gerido na listagem de produtos.</small>
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label>Imagem do Produto</label>
                    <InputFile class="form-control" OnChange="OnImagemSelecionada" accept="image/*" />
                    
                    <div class="mt-2 text-center p-2 border rounded bg-light">
                        @if (!string.IsNullOrEmpty(previewImagem))
                        {
                            <img src="@previewImagem" alt="Nova imagem" class="img-fluid img-thumbnail" style="max-height: 300px; object-fit: contain;" />
                            <p class="text-success small mt-1 mb-0">✓ Nova imagem selecionada</p>
                        }
                        else
                        {
                            <img src="img/@produto.Imagem" alt="@produto.Nome" class="img-fluid img-thumbnail" style="max-height: 300px; object-fit: contain;" />
                            <p class="text-muted small mt-1 mb-0">Imagem atual: @produto.Imagem</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <button type="submit" class="btn btn-success" disabled="@aGuardar">
            @if (aGuardar)
            {
                <span class="spinner-border spinner-border-sm me-1"></span>
                <text>A guardar...</text>
            }
            else
            {
                <text>Guardar</text>
            }
        </button>
        <button class="btn btn-secondary ms-2" type="button" @onclick="Cancelar" disabled="@aGuardar">Cancelar</button>
    </EditForm>
}

@code {
    [Parameter] public int id { get; set; }

    Produtos? produto;
    List<Categorias> categorias = new();
    List<Subcategoria> todasSubcategorias = new();
    List<Subcategoria> subcategoriasFiltradas = new();
    List<ModoEntrega> modos = new();
    List<Fornecedor> fornecedores = new();
    
    string subcategoriaIdSelecionada = "";
    
    IBrowserFile? ficheiroImagem;
    string? previewImagem;
    string? mensagemErro;
    bool aGuardar = false;
    byte[]? imagemBytes;

    protected override void OnInitialized()
    {
        produto = db.Produtos
            .Include(p => p.Categoria)
            .Include(p => p.Subcategoria)
            .Include(p => p.ModoEntrega)
            .Include(p => p.Fornecedor)
            .FirstOrDefault(p => p.Id == id);

        categorias = db.Categorias.OrderBy(c => c.Nome).ToList();
        todasSubcategorias = db.Subcategorias.OrderBy(s => s.Nome).ToList();
        modos = db.ModosEntrega.OrderBy(m => m.Tipo).ToList();
        fornecedores = db.Fornecedores
            .Where(f => f.Estado == "Aprovado")
            .ToList();

        if (produto != null)
        {
            subcategoriaIdSelecionada = produto.SubcategoriaId?.ToString() ?? "";
            FiltrarSubcategorias();
        }
    }

    void OnCategoriaChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int catId))
        {
            if (produto != null)
            {
                produto.CategoriaId = catId;
            }
        }
        FiltrarSubcategorias();
        subcategoriaIdSelecionada = "";
    }

    void FiltrarSubcategorias()
    {
        if (produto != null)
        {
            subcategoriasFiltradas = todasSubcategorias
                .Where(s => s.CategoriaId == produto.CategoriaId)
                .ToList();
        }
    }

    async Task OnImagemSelecionada(InputFileChangeEventArgs e)
    {
        mensagemErro = null;
        ficheiroImagem = e.File;

        // Validar tamanho (max 5MB)
        long maxSize = 5 * 1024 * 1024;
        if (ficheiroImagem.Size > maxSize)
        {
            mensagemErro = "A imagem não pode ter mais de 5MB.";
            ficheiroImagem = null;
            previewImagem = null;
            imagemBytes = null;
            return;
        }

        // Validar tipo
        if (!ficheiroImagem.ContentType.StartsWith("image/"))
        {
            mensagemErro = "Por favor selecione um ficheiro de imagem.";
            ficheiroImagem = null;
            previewImagem = null;
            imagemBytes = null;
            return;
        }

        try
        {
            // Ler os bytes da imagem para memória
            using var memoryStream = new MemoryStream();
            await ficheiroImagem.OpenReadStream(maxSize).CopyToAsync(memoryStream);
            imagemBytes = memoryStream.ToArray();
            
            // Criar preview
            previewImagem = $"data:{ficheiroImagem.ContentType};base64,{Convert.ToBase64String(imagemBytes)}";
        }
        catch (Exception ex)
        {
            mensagemErro = $"Erro ao ler imagem: {ex.Message}";
            ficheiroImagem = null;
            previewImagem = null;
            imagemBytes = null;
        }
    }

    async Task Guardar()
    {
        if (produto == null)
            return;

        mensagemErro = null;
        aGuardar = true;
        StateHasChanged();

        try
        {
            // Atualizar subcategoria
            produto.SubcategoriaId = string.IsNullOrEmpty(subcategoriaIdSelecionada) 
                ? null 
                : int.Parse(subcategoriaIdSelecionada);

            // Guardar nova imagem se foi selecionada
            if (imagemBytes != null && ficheiroImagem != null)
            {
                var extensao = Path.GetExtension(ficheiroImagem.Name).ToLowerInvariant();
                if (string.IsNullOrEmpty(extensao))
                    extensao = ".png";
                    
                var nomeUnico = $"prod_{Guid.NewGuid():N}{extensao}";
                var pastaImg = Path.Combine(env.WebRootPath, "img");
                
                // Garantir que a pasta existe
                if (!Directory.Exists(pastaImg))
                    Directory.CreateDirectory(pastaImg);

                var caminhoCompleto = Path.Combine(pastaImg, nomeUnico);
                
                // Escrever os bytes para o ficheiro
                await File.WriteAllBytesAsync(caminhoCompleto, imagemBytes);

                produto.Imagem = nomeUnico;
            }

            if (produto.Percentagem < 0)
                produto.Percentagem = 0;

            produto.PrecoFinal = produto.PrecoBase + (produto.PrecoBase * (produto.Percentagem / 100));

            db.Produtos.Update(produto);
            await db.SaveChangesAsync();

            nav.NavigateTo("/produtos");
        }
        catch (Exception ex)
        {
            mensagemErro = $"Erro ao guardar: {ex.Message}";
            aGuardar = false;
        }
    }

    void Cancelar() => nav.NavigateTo("/produtos");
}
