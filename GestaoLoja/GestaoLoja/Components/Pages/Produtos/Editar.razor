@page "/produtos/editar/{id:int}"
@inject ApplicationDbContext db
@inject NavigationManager nav
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrador")]

<h3>Editar Produto</h3>

@if (produto == null)
{
    <p>A carregar...</p>
}
else
{
    <EditForm Model="produto" OnValidSubmit="Guardar">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Nome</label>
            <InputText class="form-control" @bind-Value="produto.Nome" />
        </div>

        <div class="mb-3">
            <label>Preço Base (€)</label>
            <InputNumber class="form-control" @bind-Value="produto.PrecoBase" />
        </div>

        <div class="mb-3">
            <label>Percentagem (%)</label>
            <InputNumber class="form-control" @bind-Value="produto.Percentagem" />
        </div>

        <div class="mb-3">
            <label>Categoria</label>
            <InputSelect class="form-select" @bind-Value="produto.CategoriaId">
                @foreach (var c in categorias)
                {
                    <option value="@c.Id">@c.Nome</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label>Modo de Entrega</label>
            <InputSelect class="form-select" @bind-Value="produto.ModoEntregaId">
                @foreach (var m in modos)
                {
                    <option value="@m.Id">@m.Tipo</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label>Fornecedor</label>
            <InputSelect class="form-select" @bind-Value="produto.FornecedorId">
                @foreach (var f in fornecedores)
                {
                    <option value="@f.Id">@f.NomeEmpresa</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label>Estado</label>
            <InputText class="form-control" Value="@produto.Estado" disabled />
            <small class="text-muted">O estado é gerido na listagem de produtos.</small>
        </div>

        <button class="btn btn-success">Guardar</button>
        <button class="btn btn-secondary ms-2" type="button" @onclick="Cancelar">Cancelar</button>
    </EditForm>
}

@code {
    [Parameter] public int id { get; set; }

    Produtos? produto;
    List<Categorias> categorias = new();
    List<ModoEntrega> modos = new();
    List<Fornecedor> fornecedores = new();

    protected override void OnInitialized()
    {
        produto = db.Produtos
            .Include(p => p.Categoria)
            .Include(p => p.ModoEntrega)
            .Include(p => p.Fornecedor)
            .FirstOrDefault(p => p.Id == id);

        categorias = db.Categorias.OrderBy(c => c.Nome).ToList();
        modos = db.ModosEntrega.OrderBy(m => m.Tipo).ToList();
        fornecedores = db.Fornecedores
            .Where(f => f.Estado == "Aprovado")
            .ToList(); // só fornecedores aprovados
    }

    void Guardar()
    {
        if (produto == null)
            return;

        if (produto.Percentagem < 0)
            produto.Percentagem = 0;

        produto.PrecoFinal = produto.PrecoBase + (produto.PrecoBase * (produto.Percentagem / 100));

        db.Produtos.Update(produto);
        db.SaveChanges();

        nav.NavigateTo("/produtos");
    }

    void Cancelar() => nav.NavigateTo("/produtos");
}
