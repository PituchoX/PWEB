@page "/produtos/criar"
@inject ApplicationDbContext db
@inject NavigationManager nav
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrador")]

<h3>Criar Produto</h3>

<EditForm Model="produto" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Nome</label>
        <InputText class="form-control" @bind-Value="produto.Nome" />
    </div>

    <div class="mb-3">
        <label>Preço Base (€)</label>
        <InputNumber class="form-control" @bind-Value="produto.PrecoBase" />
    </div>

    <div class="mb-3">
        <label>Percentagem (%)</label>
        <InputNumber class="form-control" @bind-Value="produto.Percentagem" />
    </div>

    <div class="mb-3">
        <label>Categoria</label>
        <InputSelect class="form-select" @bind-Value="produto.CategoriaId">
            <option value="0">(Selecionar)</option>
            @foreach (var cat in categorias)
            {
                <option value="@cat.Id">@cat.Nome</option>
            }
        </InputSelect>
    </div>

    <div class="mb-3">
        <label>Modo de Entrega</label>
        <InputSelect class="form-select" @bind-Value="produto.ModoEntregaId">
            <option value="0">(Selecionar)</option>
            @foreach (var m in modos)
            {
                <option value="@m.Id">@m.Tipo</option>
            }
        </InputSelect>
    </div>

    <div class="mb-3">
        <label>Fornecedor</label>
        <InputSelect class="form-select" @bind-Value="produto.FornecedorId">
            <option value="">(Selecionar Fornecedor)</option>
            @foreach (var f in fornecedores)
            {
                <option value="@f.Id">@f.NomeEmpresa</option>
            }
        </InputSelect>
    </div>

    <button type="submit" class="btn btn-success">Guardar</button>
    <button type="button" class="btn btn-secondary ms-2" @onclick="Cancelar">Cancelar</button>
</EditForm>

@code {
    Produtos produto = new()
    {
        Estado = "Pendente",
        Imagem = "semfoto.png"
    };

    List<Categorias> categorias = new();
    List<ModoEntrega> modos = new();
    List<Fornecedor> fornecedores = new();

    protected override void OnInitialized()
    {
        categorias = db.Categorias.OrderBy(c => c.Nome).ToList();
        modos = db.ModosEntrega.OrderBy(m => m.Tipo).ToList();
        fornecedores = db.Fornecedores
            .Where(f => f.Estado == "Aprovado")
            .ToList();
    }

    void Guardar()
    {
        if (produto.CategoriaId == 0 || produto.ModoEntregaId == 0 || produto.FornecedorId == 0)
            return;

        if (produto.Percentagem < 0)
            produto.Percentagem = 0;

        produto.PrecoFinal = produto.PrecoBase + (produto.PrecoBase * (produto.Percentagem / 100));

        db.Produtos.Add(produto);
        db.SaveChanges();
        nav.NavigateTo("/produtos");
    }

    void Cancelar() => nav.NavigateTo("/produtos");
}
