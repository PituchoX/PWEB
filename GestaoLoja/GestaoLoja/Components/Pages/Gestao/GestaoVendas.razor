@page "/gestao/vendas"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrador,Funcionário")]
@inject GestaoLoja.Data.ApplicationDbContext _context
@using GestaoLoja.Entities
@using Microsoft.EntityFrameworkCore

<h3><i class="bi bi-receipt me-2"></i>Gestao de Vendas</h3>

@if (carregando)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">A carregar vendas...</p>
    </div>
}
else
{
    <!-- Vendas Pendentes -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <i class="bi bi-clock me-2"></i>Vendas Pendentes (@vendasPendentes.Count)
        </div>
        <div class="card-body">
            @if (vendasPendentes.Count == 0)
            {
                <p class="text-muted mb-0">Nao existem vendas pendentes.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Produtos</th>
                                <th>Total</th>
                                <th style="width: 200px;">Acoes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in vendasPendentes)
                            {
                                var total = v.LinhasVenda?.Sum(l => l.Preco * l.Quantidade) ?? 0;
                                <tr>
                                    <td><strong>#@v.Id</strong></td>
                                    <td>@v.Cliente?.ApplicationUser?.NomeCompleto</td>
                                    <td>@v.Data</td>
                                    <td>
                                        @if (v.LinhasVenda != null)
                                        {
                                            @foreach (var linha in v.LinhasVenda)
                                            {
                                                <div class="small">
                                                    <span class="badge bg-secondary me-1">@linha.Quantidade x</span>
                                                    @linha.Produto?.Nome - @linha.Preco.ToString("C2")
                                                </div>
                                            }
                                        }
                                    </td>
                                    <td><strong class="text-primary">@total.ToString("C2")</strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-success me-1" @onclick="() => Confirmar(v.Id)">
                                            <i class="bi bi-check me-1"></i>Confirmar
                                        </button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => Rejeitar(v.Id)">
                                            <i class="bi bi-x me-1"></i>Rejeitar
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Vendas Confirmadas -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>Vendas Confirmadas (@vendasConfirmadas.Count)
        </div>
        <div class="card-body">
            @if (vendasConfirmadas.Count == 0)
            {
                <p class="text-muted mb-0">Nao existem vendas confirmadas.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Produtos</th>
                                <th>Total</th>
                                <th style="width: 120px;">Acoes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in vendasConfirmadas)
                            {
                                var total = v.LinhasVenda?.Sum(l => l.Preco * l.Quantidade) ?? 0;
                                <tr>
                                    <td><strong>#@v.Id</strong></td>
                                    <td>@v.Cliente?.ApplicationUser?.NomeCompleto</td>
                                    <td>@v.Data</td>
                                    <td>
                                        @if (v.LinhasVenda != null)
                                        {
                                            @foreach (var linha in v.LinhasVenda)
                                            {
                                                <div class="small">
                                                    <span class="badge bg-secondary me-1">@linha.Quantidade x</span>
                                                    @linha.Produto?.Nome
                                                </div>
                                            }
                                        }
                                    </td>
                                    <td><strong class="text-primary">@total.ToString("C2")</strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @onclick="() => Expedir(v.Id)">
                                            <i class="bi bi-truck me-1"></i>Expedir
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Vendas Expedidas -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <i class="bi bi-truck me-2"></i>Vendas Expedidas (@vendasExpedidas.Count)
        </div>
        <div class="card-body">
            @if (vendasExpedidas.Count == 0)
            {
                <p class="text-muted mb-0">Nao existem vendas expedidas.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Produtos</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in vendasExpedidas)
                            {
                                var total = v.LinhasVenda?.Sum(l => l.Preco * l.Quantidade) ?? 0;
                                <tr>
                                    <td><strong>#@v.Id</strong></td>
                                    <td>@v.Cliente?.ApplicationUser?.NomeCompleto</td>
                                    <td>@v.Data</td>
                                    <td>
                                        @if (v.LinhasVenda != null)
                                        {
                                            @foreach (var linha in v.LinhasVenda)
                                            {
                                                <div class="small">
                                                    <span class="badge bg-secondary me-1">@linha.Quantidade x</span>
                                                    @linha.Produto?.Nome
                                                </div>
                                            }
                                        }
                                    </td>
                                    <td><strong class="text-primary">@total.ToString("C2")</strong></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Vendas Rejeitadas -->
    @if (vendasRejeitadas.Count > 0)
    {
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-x-circle me-2"></i>Vendas Rejeitadas (@vendasRejeitadas.Count)
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Produtos</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in vendasRejeitadas)
                            {
                                var total = v.LinhasVenda?.Sum(l => l.Preco * l.Quantidade) ?? 0;
                                <tr>
                                    <td><strong>#@v.Id</strong></td>
                                    <td>@v.Cliente?.ApplicationUser?.NomeCompleto</td>
                                    <td>@v.Data</td>
                                    <td>
                                        @if (v.LinhasVenda != null)
                                        {
                                            @foreach (var linha in v.LinhasVenda)
                                            {
                                                <div class="small">
                                                    <span class="badge bg-secondary me-1">@linha.Quantidade x</span>
                                                    @linha.Produto?.Nome
                                                </div>
                                            }
                                        }
                                    </td>
                                    <td><strong class="text-muted">@total.ToString("C2")</strong></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
}

@code {
    private bool carregando = true;

    private List<Vendas> vendasPendentes = new();
    private List<Vendas> vendasConfirmadas = new();
    private List<Vendas> vendasExpedidas = new();
    private List<Vendas> vendasRejeitadas = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarVendas();
    }

    private async Task CarregarVendas()
    {
        carregando = true;

        var todas = await _context.Vendas
            .Include(v => v.Cliente)
                .ThenInclude(c => c!.ApplicationUser)
            .Include(v => v.LinhasVenda!)
                .ThenInclude(l => l.Produto!)
            .OrderByDescending(v => v.Data)
            .ToListAsync();

        vendasPendentes = todas.Where(v => v.Estado == "Pendente").ToList();
        vendasConfirmadas = todas.Where(v => v.Estado == "Confirmada").ToList();
        vendasExpedidas = todas.Where(v => v.Estado == "Expedida").ToList();
        vendasRejeitadas = todas.Where(v => v.Estado == "Rejeitada").ToList();

        carregando = false;
    }

    private async Task Confirmar(int id)
    {
        var venda = await _context.Vendas
            .Include(v => v.LinhasVenda!)
                .ThenInclude(l => l.Produto!)
            .FirstOrDefaultAsync(v => v.Id == id);

        if (venda == null)
            return;

        // Deduzir stock dos produtos ao confirmar
        foreach (var linha in venda.LinhasVenda!)
        {
            if (linha.Produto != null)
            {
                linha.Produto.Stock -= linha.Quantidade;
                if (linha.Produto.Stock < 0)
                    linha.Produto.Stock = 0;
            }
        }

        venda.Estado = "Confirmada";
        await _context.SaveChangesAsync();
        await CarregarVendas();
    }

    private async Task Rejeitar(int id)
    {
        var venda = await _context.Vendas.FindAsync(id);
        if (venda == null)
            return;

        // Nao deduz stock - venda rejeitada
        venda.Estado = "Rejeitada";
        await _context.SaveChangesAsync();
        await CarregarVendas();
    }

    private async Task Expedir(int id)
    {
        var venda = await _context.Vendas.FindAsync(id);
        if (venda == null)
            return;

        venda.Estado = "Expedida";
        await _context.SaveChangesAsync();
        await CarregarVendas();
    }
}
