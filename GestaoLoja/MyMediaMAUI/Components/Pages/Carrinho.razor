@page "/carrinho"
@inject CarrinhoService CarrinhoService
@inject NavigationManager Nav

<div class="container py-4">
    <h2 class="mb-4">
        <i class="bi bi-cart3 me-2"></i>Carrinho de Compras
    </h2>

    @if (!CarrinhoService.Itens.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <h4 class="mt-3 text-muted">O seu carrinho está vazio</h4>
            <a href="/" class="btn btn-primary mt-3">
                <i class="bi bi-arrow-left me-2"></i>Continuar a comprar
            </a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                @foreach (var item in CarrinhoService.Itens)
                {
                    <div class="carrinho-item">
                        <img src="@GetImageUrl(item.ProdutoImagem)" alt="@item.ProdutoNome"
                             onerror="this.src='img/noproductstrans.png'" />
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">@item.ProdutoNome</h6>
                            <p class="text-muted mb-1 small">@item.PrecoUnitario.ToString("C2") cada</p>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => Diminuir(item)">-</button>
                                <span class="mx-2">@item.Quantidade</span>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => Aumentar(item)">+</button>
                                <button class="btn btn-sm btn-outline-danger ms-3" @onclick="() => Remover(item)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-end">
                            <strong class="text-primary">@item.Subtotal.ToString("C2")</strong>
                        </div>
                    </div>
                }
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5>Resumo</h5>
                        <hr />
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal (@CarrinhoService.TotalItens itens)</span>
                            <span>@CarrinhoService.Total.ToString("C2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Envio</span>
                            <span class="text-success">Gratis</span>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total</strong>
                            <strong class="text-primary fs-5">@CarrinhoService.Total.ToString("C2")</strong>
                        </div>
                        <button class="btn btn-warning w-100" @onclick="Checkout">
                            <i class="bi bi-credit-card me-2"></i>Finalizar Compra
                        </button>
                        <button class="btn btn-outline-danger w-100 mt-2" @onclick="LimparCarrinho">
                            <i class="bi bi-trash me-2"></i>Limpar Carrinho
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string ApiBaseUrl => MauiProgram.ApiBaseUrl;

    private string GetImageUrl(string? imagem)
    {
        if (string.IsNullOrEmpty(imagem))
            return "img/noproductstrans.png";
        return $"{ApiBaseUrl}img/{imagem}";
    }

    private void Aumentar(ItemCarrinhoDto item)
    {
        CarrinhoService.AumentarQuantidade(item.ProdutoId);
    }

    private void Diminuir(ItemCarrinhoDto item)
    {
        CarrinhoService.DiminuirQuantidade(item.ProdutoId);
    }

    private void Remover(ItemCarrinhoDto item)
    {
        CarrinhoService.RemoverItem(item.ProdutoId);
    }

    private void LimparCarrinho()
    {
        CarrinhoService.LimparCarrinho();
    }

    private void Checkout()
    {
        Nav.NavigateTo("/checkout");
    }
}
