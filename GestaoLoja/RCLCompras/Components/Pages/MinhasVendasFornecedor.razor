@page "/minhas-vendas"
@inject ApiService Api
@inject NavigationManager Nav

<PageTitle>Minhas Vendas - MyMEDIA</PageTitle>

<div class="container py-3">
    <h4 class="mb-3">
        <i class="bi bi-graph-up me-2"></i>Histórico de Vendas
    </h4>

    @if (carregando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">A carregar...</span>
            </div>
        </div>
    }
    else if (!Api.IsAuthenticated)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Precisa de <a href="/login?returnUrl=/minhas-vendas">entrar</a> para ver as suas vendas.
        </div>
    }
    else if (Api.GetUserInfo()?.Perfil != "Fornecedor")
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Esta página é apenas para fornecedores.
        </div>
    }
    else if (vendas == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">A carregar vendas...</span>
            </div>
        </div>
    }
    else if (!vendas.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-graph-down display-1 text-muted"></i>
            <h5 class="mt-3 text-muted">Ainda não tem vendas</h5>
            <p class="text-muted">As vendas dos seus produtos aparecerão aqui.</p>
            <a href="/meus-produtos" class="btn btn-primary mt-3">
                <i class="bi bi-box me-2"></i>Ver Meus Produtos
            </a>
        </div>
    }
    else
    {
        <!-- Resumo - Responsivo (apenas vendas confirmadas e expedidas) -->
        <div class="row g-2 mb-3">
            <div class="col-4">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body text-center p-2">
                        <h4 class="mb-0">@vendas.Count</h4>
                        <small>Vendas</small>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card bg-success text-white h-100">
                    <div class="card-body text-center p-2">
                        <h4 class="mb-0">@VendasValidas.Sum(v => v.Quantidade)</h4>
                        <small>Unidades</small>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card bg-warning text-dark h-100">
                    <div class="card-body text-center p-2">
                        <h4 class="mb-0">@VendasValidas.Sum(v => v.Total).ToString("0.00")€</h4>
                        <small>Total</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Desktop (tabela) - escondida em mobile -->
        <div class="card d-none d-md-block">
            <div class="card-header py-2">
                <i class="bi bi-list me-2"></i>Lista de Vendas
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Data</th>
                                <th>Produto</th>
                                <th class="text-center">Qtd</th>
                                <th class="text-end">Total</th>
                                <th>Cliente</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var venda in vendas)
                            {
                                <tr>
                                    <td><strong>#@venda.VendaId</strong></td>
                                    <td>@venda.Data</td>
                                    <td>@venda.ProdutoNome</td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">@venda.Quantidade</span>
                                    </td>
                                    <td class="text-end"><strong>@venda.Total.ToString("0.00") €</strong></td>
                                    <td>@venda.ClienteNome</td>
                                    <td>
                                        <span class="badge @GetEstadoBadgeClass(venda.Estado)">@venda.Estado</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vista Mobile (cards) - visível apenas em mobile -->
        <div class="d-md-none">
            @foreach (var venda in vendas)
            {
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="text-primary">#@venda.VendaId</strong>
                                <span class="badge @GetEstadoBadgeClass(venda.Estado) ms-2">@venda.Estado</span>
                            </div>
                            <small class="text-muted">@venda.Data</small>
                        </div>
                        
                        <h6 class="mb-1">@venda.ProdutoNome</h6>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-light text-dark me-2">
                                    <i class="bi bi-box me-1"></i>@venda.Quantidade un.
                                </span>
                                <small class="text-muted">
                                    <i class="bi bi-person me-1"></i>@venda.ClienteNome
                                </small>
                            </div>
                            <strong class="text-success fs-5">@venda.Total.ToString("0.00") €</strong>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Total geral mobile (apenas vendas confirmadas e expedidas) -->
            <div class="card bg-light">
                <div class="card-body p-2 d-flex justify-content-between align-items-center">
                    <strong>Total Geral:</strong>
                    <span class="text-primary fs-4 fw-bold">@VendasValidas.Sum(v => v.Total).ToString("0.00") €</span>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<VendaFornecedorDto>? vendas;
    private bool carregando = true;

    // Vendas válidas para cálculo de totais (exclui Rejeitadas e Canceladas)
    private IEnumerable<VendaFornecedorDto> VendasValidas => 
        vendas?.Where(v => v.Estado == "Confirmada" || v.Estado == "Expedida") 
        ?? Enumerable.Empty<VendaFornecedorDto>();

    protected override async Task OnInitializedAsync()
    {
        // Aguardar que a API inicialize (restaurar sessão do localStorage)
        await Api.InitializeAsync();
        carregando = false;
        
        if (Api.IsAuthenticated && Api.GetUserInfo()?.Perfil == "Fornecedor")
        {
            vendas = await Api.GetMinhasVendasFornecedorAsync();
        }
    }

    private string GetEstadoBadgeClass(string? estado) => estado switch
    {
        "Pendente" => "bg-warning text-dark",
        "Confirmada" => "bg-success",
        "Expedida" => "bg-info",
        "Entregue" => "bg-primary",
        "Rejeitada" => "bg-danger",
        "Cancelada" => "bg-secondary",
        _ => "bg-secondary"
    };
}
