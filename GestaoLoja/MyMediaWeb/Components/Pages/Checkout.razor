@page "/checkout"
@inject CarrinhoService CarrinhoService
@inject ApiService Api
@inject NavigationManager Nav
@inject IConfiguration Config

<div class="container py-4">
    <h2 class="mb-4"><i class="bi bi-credit-card me-2"></i>Finalizar Compra</h2>

    @if (!Api.IsAuthenticated)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Precisa de <a href="/login?returnUrl=/checkout">entrar</a> para finalizar a compra.
        </div>
    }
    else if (!CarrinhoService.Itens.Any() && !compraFinalizada)
    {
        <div class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <h4 class="mt-3 text-muted">O seu carrinho esta vazio</h4>
            <a href="/" class="btn btn-primary mt-3">Continuar a comprar</a>
        </div>
    }
    else if (compraFinalizada)
    {
        <!-- Confirmacao de Sucesso -->
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-check-circle-fill text-success display-1"></i>
                        <h4 class="mt-3 text-success">Encomenda Registada!</h4>
                        <p class="text-muted">A sua encomenda aguarda confirmacao.</p>
                        
                        <div class="alert alert-light border mt-3 text-start">
                            <p class="mb-1"><strong>Encomenda #@vendaId</strong></p>
                            <p class="mb-1">Metodo: @metodoPagamento</p>
                            @if (metodoPagamento == "MB WAY")
                            {
                                <p class="mb-1">Telemovel: +351 @numeroTelemovel</p>
                            }
                            @if (metodoPagamento == "Multibanco")
                            {
                                <p class="mb-1">Entidade: @entidadeMultibanco | Ref: @referenciaMultibanco</p>
                            }
                            <p class="mb-0">Total: <strong class="text-success">@totalPago.ToString("C2")</strong></p>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            A encomenda sera processada apos confirmacao.
                        </div>

                        <p class="text-muted mt-3">
                            <i class="bi bi-arrow-right me-1"></i>
                            A redirecionar para as suas compras...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Resumo do Pedido -->
            <div class="col-lg-7">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-bag me-2"></i>Resumo do Pedido
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center">Qtd</th>
                                    <th class="text-end">Preco</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in CarrinhoService.Itens)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="@($"{Config["ApiBaseUrl"]}img/{item.ProdutoImagem}")"
                                                     alt="@item.ProdutoNome"
                                                     style="width: 50px; height: 50px; object-fit: cover;"
                                                     class="me-2 rounded"
                                                     onerror="this.src='/img/noproducts.png'" />
                                                <span>@item.ProdutoNome</span>
                                            </div>
                                        </td>
                                        <td class="text-center">@item.Quantidade</td>
                                        <td class="text-end">@item.PrecoUnitario.ToString("C2")</td>
                                        <td class="text-end fw-bold">@item.Subtotal.ToString("C2")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="3" class="text-end fw-bold">Total:</td>
                                    <td class="text-end fw-bold text-primary fs-5">@CarrinhoService.Total.ToString("C2")</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <a href="/carrinho" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Voltar ao Carrinho
                </a>
            </div>

            <!-- Pagamento -->
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-credit-card me-2"></i>Pagamento (Simulado)
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Nota:</strong> Apos o pagamento, a encomenda aguarda confirmacao.
                        </div>

                        <!-- Metodo de Pagamento -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Metodo de Pagamento</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="metodoPagamento" id="cartao" checked="@(metodoPagamento == "Cartao")" @onchange="SetMetodoCartao">
                                <label class="form-check-label" for="cartao">
                                    <i class="bi bi-credit-card me-2"></i>Cartao de Credito/Debito
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="metodoPagamento" id="mbway" checked="@(metodoPagamento == "MB WAY")" @onchange="SetMetodoMBWay">
                                <label class="form-check-label" for="mbway">
                                    <i class="bi bi-phone me-2"></i>MB WAY
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="metodoPagamento" id="multibanco" checked="@(metodoPagamento == "Multibanco")" @onchange="SetMetodoMultibanco">
                                <label class="form-check-label" for="multibanco">
                                    <i class="bi bi-bank me-2"></i>Multibanco
                                </label>
                            </div>
                        </div>

                        <!-- Campos Cartao -->
                        @if (metodoPagamento == "Cartao")
                        {
                            <div class="mb-3">
                                <label class="form-label">Numero do Cartao</label>
                                <input type="text" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" @bind="numeroCartao" />
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">Validade</label>
                                    <input type="text" class="form-control" placeholder="MM/AA" maxlength="5" @bind="validadeCartao" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label">CVV</label>
                                    <input type="text" class="form-control" placeholder="123" maxlength="3" @bind="cvvCartao" />
                                </div>
                            </div>
                        }

                        <!-- Campos MB WAY -->
                        @if (metodoPagamento == "MB WAY")
                        {
                            <div class="mb-3">
                                <label class="form-label">Numero de Telemovel</label>
                                <div class="input-group">
                                    <span class="input-group-text">+351</span>
                                    <input type="text" class="form-control" placeholder="912 345 678" maxlength="9" @bind="numeroTelemovel" />
                                </div>
                                <small class="text-muted">Ira receber uma notificacao na app MB WAY</small>
                            </div>
                        }

                        <!-- Campos Multibanco -->
                        @if (metodoPagamento == "Multibanco")
                        {
                            <div class="alert alert-light border mb-3">
                                <h6 class="fw-bold mb-3"><i class="bi bi-bank me-2"></i>Dados para Pagamento</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Entidade</small>
                                        <p class="fw-bold fs-5 mb-2">@entidadeMultibanco</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Referencia</small>
                                        <p class="fw-bold fs-5 mb-2">@referenciaMultibanco</p>
                                    </div>
                                </div>
                                <div>
                                    <small class="text-muted">Montante</small>
                                    <p class="fw-bold fs-5 text-success mb-0">@CarrinhoService.Total.ToString("C2")</p>
                                </div>
                                <hr />
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Pague num multibanco ou homebanking. Valido por 72 horas.
                                </small>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(mensagemErro))
                        {
                            <div class="alert alert-danger">@mensagemErro</div>
                        }

                        <hr />

                        <div class="d-flex justify-content-between mb-3">
                            <span class="fs-5">Total a Pagar:</span>
                            <span class="fs-4 fw-bold text-success">@CarrinhoService.Total.ToString("C2")</span>
                        </div>

                        <button class="btn btn-success w-100 btn-lg" @onclick="ProcessarPagamento" disabled="@processando">
                            @if (processando)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>A processar...</span>
                            }
                            else
                            {
                                <i class="bi bi-lock me-2"></i>
                                <span>Confirmar Encomenda</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string metodoPagamento = "Cartao";
    
    // Cartao
    private string numeroCartao = "";
    private string validadeCartao = "";
    private string cvvCartao = "";
    
    // MB WAY
    private string numeroTelemovel = "";
    
    // Multibanco (simulado)
    private string entidadeMultibanco = "21312";
    private string referenciaMultibanco = "";
    
    private bool processando = false;
    private bool compraFinalizada = false;
    private string? mensagemErro;
    
    private int vendaId;
    private decimal totalPago;

    protected override void OnInitialized()
    {
        // Gerar referencia multibanco aleatoria
        var random = new Random();
        referenciaMultibanco = $"{random.Next(100, 999)} {random.Next(100, 999)} {random.Next(100, 999)}";
    }

    private void SetMetodoCartao() => metodoPagamento = "Cartao";
    private void SetMetodoMBWay() => metodoPagamento = "MB WAY";
    private void SetMetodoMultibanco() => metodoPagamento = "Multibanco";

    private async Task ProcessarPagamento()
    {
        processando = true;
        mensagemErro = null;

        try
        {
            // Validar campos conforme metodo
            if (metodoPagamento == "MB WAY" && string.IsNullOrWhiteSpace(numeroTelemovel))
            {
                mensagemErro = "Por favor introduza o numero de telemovel.";
                return;
            }

            // Simular delay de processamento
            await Task.Delay(1500);

            // Criar a venda na API
            var venda = CarrinhoService.GetVendaDto();
            var (resultado, erro) = await Api.CriarVendaAsync(venda);

            if (resultado != null)
            {
                vendaId = resultado.Id;
                totalPago = CarrinhoService.Total;
                
                // Registar pagamento (venda continua Pendente ate admin confirmar)
                await Api.SimularPagamentoAsync(vendaId);
                
                CarrinhoService.LimparCarrinho();
                compraFinalizada = true;
                
                // Redirecionar para Minhas Compras apos 2 segundos
                await Task.Delay(2000);
                Nav.NavigateTo("/minhas-compras");
            }
            else
            {
                mensagemErro = erro ?? "Erro ao processar a encomenda. Tente novamente.";
            }
        }
        catch (Exception ex)
        {
            mensagemErro = $"Erro: {ex.Message}";
        }
        finally
        {
            processando = false;
        }
    }
}
